name: SEV CI PR test

on:
  pull_request_target:
    types: 
      - reopened
      - opened
      - edited
  workflow_dispatch:
  
jobs:
  snp_host_tests:
    runs-on: self-hosted
    steps:
      - name: Checkout Repository
        uses: actions/checkout@v2
              
      - name: Verify if SNP is enabled on the host
        run: |
              if ! sudo dmesg | grep -i "SEV-SNP enabled" 2>&1 >/dev/null; then
                echo "SEV-SNP not enabled on the host."
                exit 1
              fi
              echo "SEV-SNP is enabled on the host."

      - name: SEV library PR test on the host
        run: |
              # Give user access to /dev/sev to run cargo tests w/o permission issues
              sudo usermod -a -G kvm $USER
              sudo setfacl -m g:kvm:rw /dev/sev

              # Fetch and checkout SEV PR on the host
              rm -rf ~/sev
              git clone https://github.com/virtee/sev.git
              cd sev
              git fetch origin pull/${{ github.event.pull_request.number }}/head:${{ github.head_ref }}
              git switch ${{ github.head_ref }}

              # Install Rust on the host
              source "${HOME}/.cargo/env" 2>/dev/null || true
              if ! command -v rustc &> /dev/null; then
                echo "Installing Rust..."
                curl --proto '=https' --tlsv1.2 -sSf https://sh.rustup.rs -sSf | sh -s -- -y
                source "${HOME}/.cargo/env" 2>/dev/null
              fi

              # Cargo SEV PR test on the host
              cargo test 
          
  snp_guest_tests:
    runs-on: self-hosted
    steps:
      - name: Checkout Repository
        uses: actions/checkout@v2
 
      - name: SEV library PR test on the guest
        run: |
          # Launch and verify SNP enabled Guest
          rm -rf ~/snp.sh
          wget https://raw.githubusercontent.com/LakshmiSaiHarika/sev-utils/Fedora-Latest-SNP-kernel-Upstream/tools/snp.sh
          chmod +x snp.sh
          ./snp.sh launch-guest
          
          # Install sev dependencies as a root user 
           ssh_guest_command "sudo su - <<EOF
           curl --proto '=https' --tlsv1.2 -sSf https://sh.rustup.rs -sSf | sh -s -- -y
           source "${HOME}/.cargo/env" 2>/dev/null
           sudo dnf install -y git gcc
          EOF"
  
          # Clean up previous sev, clone and perform PR test on sev library as root user to fix OS permission denied issues
          ssh_guest_command "sudo su - <<EOF
          rm -rf ~/sev
          git clone https://github.com/virtee/sev.git
          cd ~/sev
          git fetch origin pull/${{ github.event.pull_request.number }}/head:${{ github.head_ref }}
          git switch ${{ github.head_ref }}
          cargo test
          EOF"
